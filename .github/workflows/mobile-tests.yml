name: Mobile Tests (Appium)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  appium-mobile-tests:
    runs-on: ubuntu-latest

    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      PATH: /usr/local/lib/android/sdk/emulator:/usr/local/lib/android/sdk/platform-tools:/usr/local/lib/android/sdk/cmdline-tools/3.0/bin:$PATH

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js (Appium 3 requires Node 20+)
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Appium + Drivers
      run: |
        npm install -g appium@latest
        appium driver install uiautomator2
        appium driver install chromium

    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install Android SDK Components (API 30 default)
      run: |
        yes | sdkmanager --licenses || true
        sdkmanager "platform-tools" \
                   "platforms;android-30" \
                   "system-images;android-30;default;x86_64"

    - name: Remove old emulators
      run: |
        rm -rf $ANDROID_HOME/avd/*

    - name: Create Android Emulator (API 30)
      run: |
        echo "no" | avdmanager create avd -n ci \
          -k "system-images;android-30;default;x86_64" \
          --device "pixel" --force

    - name: Start Emulator (Non-accelerated stable mode)
      run: |
        emulator -avd ci \
          -no-window \
          -no-audio \
          -no-snapshot \
          -no-boot-anim \
          -gpu swiftshader_indirect &
        adb wait-for-device

        echo "‚è≥ Waiting for emulator boot..."
        adb shell 'while [[ $(getprop sys.boot_completed) != "1" ]]; do sleep 3; done'
        echo "üéâ Emulator booted!"

    - name: Disable Animations (Improves stability)
      run: |
        adb shell settings put global window_animation_scale 0
        adb shell settings put global transition_animation_scale 0
        adb shell settings put global animator_duration_scale 0

    - name: Start Appium Server
      run: |
        appium --base-path /wd/hub &
        sleep 8

    - name: Run Appium Mobile Tests
      run: pytest -k mobile
