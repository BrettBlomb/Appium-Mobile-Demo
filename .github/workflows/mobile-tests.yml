name: Mobile Tests (Appium)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  android-tests:
    runs-on: macos-latest   # ← CRITICAL FIX: Use macOS, not Linux

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Appium + Drivers
      run: |
        npm install -g appium@latest
        appium driver install uiautomator2
        appium driver install chromium

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install python deps
      run: |
        pip install -r requirements.txt

    # -----------------------------------------------------
    #    STABLE EMULATOR ON GITHUB — USES macOS RUNNER
    # -----------------------------------------------------
    - name: Install AVD
      run: |
        sudo $ANDROID_HOME/tools/bin/sdkmanager "system-images;android-30;google_apis;x86_64"
        sudo $ANDROID_HOME/tools/bin/sdkmanager --licenses <<< "y"
        echo "no" | $ANDROID_HOME/tools/bin/avdmanager create avd \
            -n ci -k "system-images;android-30;google_apis;x86_64" \
            --abi x86_64 --device "pixel"

    - name: Boot emulator
      run: |
        $ANDROID_HOME/emulator/emulator -avd ci -no-window -no-snapshot -gpu swiftshader_indirect &

        echo "Waiting for device..."
        $ANDROID_HOME/platform-tools/adb wait-for-device

        echo "Waiting for boot complete..."
        until [[ "$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed | tr -d '\r')" == "1" ]]; do
          sleep 2
        done

    - name: Disable animations
      run: |
        adb shell settings put global window_animation_scale 0
        adb shell settings put global transition_animation_scale 0
        adb shell settings put global animator_duration_scale 0

    - name: Start Appium
      run: |
        appium --base-path /wd/hub &
        sleep 10

    - name: Run tests
      run: pytest -k mobile
