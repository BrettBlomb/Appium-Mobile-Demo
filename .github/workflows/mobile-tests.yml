name: Mobile Tests (Appium)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  android-tests:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Appium + Drivers
      run: |
        npm install -g appium@latest
        appium driver install uiautomator2
        appium driver install chromium

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install python deps
      run: |
        pip install -r requirements.txt

    - name: Accept Android SDK Licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Install Android system image (API 30)
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-30" \
            "system-images;android-30;google_apis;x86_64"

    - name: Create AVD
      run: |
        echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n ci \
            --abi x86_64 \
            -k "system-images;android-30;google_apis;x86_64" \
            --device "pixel"

    - name: Boot emulator
      run: |
        $ANDROID_HOME/emulator/emulator \
          -avd ci \
          -no-window \
          -gpu swiftshader_indirect &

        echo "Waiting for device..."
        $ANDROID_HOME/platform-tools/adb wait-for-device

        echo "Waiting for boot..."
        until [[ "$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed | tr -d '\r')" == "1" ]]; do
          sleep 2
        done
        echo "Emulator booted!"

    - name: Disable animations
      run: |
        $ANDROID_HOME/platform-tools/adb shell settings put global window_animation_scale 0
        $ANDROID_HOME/platform-tools/adb shell settings put global transition_animation_scale 0
        $ANDROID_HOME/platform-tools/adb shell settings put global animator_duration_scale 0

    - name: Start Appium
      run: |
        appium --base-path /wd/hub &
        sleep 10

    - name: Run tests
      run: pytest -k mobile
