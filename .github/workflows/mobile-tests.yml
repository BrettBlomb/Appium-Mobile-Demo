name: Mobile Tests (Appium via Firebase Test Lab)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  appium-ftl:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install gcloud CLI
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Download Firebase Appium test wrapper APK
      run: |
        wget https://storage.googleapis.com/firebase-preview-drop/appium/appium-wrapper.apk -O appium-wrapper.apk

    - name: Create Appium test bundle
      run: |
        mkdir -p appium-tests
        cp -R tests/ appium-tests/tests
        cp requirements.txt appium-tests/requirements.txt

        cat << 'EOF' > appium-tests/run.sh
        #!/bin/bash
        pip install -r requirements.txt
        pytest -k mobile --disable-warnings -q
        EOF

        chmod +x appium-tests/run.sh
        zip -r appium-tests.zip appium-tests

    - name: Run Appium tests in Firebase Test Lab
      run: |
        gcloud firebase test android run \
          --type=appium \
          --app=appium-wrapper.apk \
          --test=appium-tests.zip \
          --device model=Pixel2,version=30,locale=en,orientation=portrait \
          --timeout 10m \
          --results-dir=appium_ftl_results

    - name: Upload Test Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firebase-test-results
        path: appium_ftl_results
