name: Mobile Tests (Appium)

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  appium-mobile-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Appium and Drivers
      run: |
        npm install -g appium@latest
        appium driver install uiautomator2
        appium driver install chromium

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    #######################################################################
    #           FIND ANDROID SDK COMMAND LINE TOOLS DYNAMICALLY
    #######################################################################

    - name: Find sdkmanager
      id: find_sdk
      run: |
        SDKMANAGER_PATH=$(find /usr/local/lib/android/sdk -type f -name "sdkmanager" | head -n 1)
        if [ -z "$SDKMANAGER_PATH" ]; then
          echo "‚ùå sdkmanager not found"
          exit 1
        fi
        echo "SDKMANAGER=$SDKMANAGER_PATH" >> $GITHUB_ENV
        echo "sdkmanager found at $SDKMANAGER_PATH"

    - name: Find avdmanager
      id: find_avd
      run: |
        AVDMANAGER_PATH=$(find /usr/local/lib/android/sdk -type f -name "avdmanager" | head -n 1)
        if [ -z "$AVDMANAGER_PATH" ]; then
          echo "‚ùå avdmanager not found"
          exit 1
        fi
        echo "AVDMANAGER=$AVDMANAGER_PATH" >> $GITHUB_ENV
        echo "avdmanager found at $AVDMANAGER_PATH"

    #######################################################################
    #                 ADD ANDROID TOOLS TO PATH (CRITICAL)
    #######################################################################

    - name: Add Android tools to PATH
      run: |
        echo "/usr/local/lib/android/sdk/emulator" >> $GITHUB_PATH
        echo "/usr/local/lib/android/sdk/platform-tools" >> $GITHUB_PATH
        echo "/usr/local/lib/android/sdk/cmdline-tools" >> $GITHUB_PATH
        echo "/usr/local/lib/android/sdk/cmdline-tools/bin" >> $GITHUB_PATH

    #######################################################################
    #        INSTALL ANDROID SDK COMPONENTS (Google APIs Image)
    #######################################################################

    - name: Accept Android SDK licenses
      run: yes | "$SDKMANAGER" --licenses

    - name: Install Android SDK packages (API 30)
      run: |
        "$SDKMANAGER" "platform-tools" \
                      "platforms;android-30" \
                      "system-images;android-30;google_apis;x86_64"

    #######################################################################
    #                         CREATE EMULATOR
    #######################################################################

    - name: Remove old emulators
      run: rm -rf $HOME/.android/avd/*

    - name: Create Android Emulator
      run: |
        # Fix GitHub runner bug: pre-create AVD directory
        mkdir -p ~/.android/avd/ci.avd
        touch ~/.android/avd/ci.ini

        echo "no" | "$AVDMANAGER" create avd -n ci \
          -k "system-images;android-30;google_apis;x86_64" \
          --device "pixel_5" --force || true

        # Ensure config.ini exists
        if [ ! -f ~/.android/avd/ci.avd/config.ini ]; then
          touch ~/.android/avd/ci.avd/config.ini
        fi

        # Patch AVD config
        echo "hw.gpu.mode=swiftshader_indirect" >> ~/.android/avd/ci.avd/config.ini
        echo "hw.gpu.enabled=yes" >> ~/.android/avd/ci.avd/config.ini
        echo "hw.ramSize=2048" >> ~/.android/avd/ci.avd/config.ini
        echo "skin.dynamic=yes" >> ~/.android/avd/ci.avd/config.ini

    #######################################################################
    #                           START EMULATOR
    #######################################################################

    - name: Start Emulator
      run: |
        emulator -avd ci \
          -no-window \
          -no-audio \
          -no-snapshot \
          -no-boot-anim \
          -gpu swiftshader_indirect &

        echo "Waiting for device..."
        adb wait-for-device

        echo "Waiting for boot..."
        for i in {1..60}; do
          if adb shell getprop sys.boot_completed | grep -q "1"; then
            echo "üéâ Boot complete!"
            break
          fi
          echo "‚è≥ Booting... ($i/60)"
          sleep 5
        done

        adb shell getprop sys.boot_completed | grep -q "1" || {
          echo "‚ùå Emulator failed to boot!"
          exit 1
        }

    #######################################################################
    #                        DISABLE ANIMATIONS
    #######################################################################

    - name: Disable animations
      run: |
        adb shell settings put global window_animation_scale 0
        adb shell settings put global transition_animation_scale 0
        adb shell settings put global animator_duration_scale 0

    #######################################################################
    #                         START APPIUM SERVER
    #######################################################################

    - name: Start Appium Server
      run: |
        appium --base-path /wd/hub &
        sleep 10

    #######################################################################
    #                          RUN TESTS
    #######################################################################

    - name: Run Mobile Tests
      run: pytest -k mobile
